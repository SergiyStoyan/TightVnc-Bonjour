<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
<HEAD>
	<META HTTP-EQUIV="CONTENT-TYPE" CONTENT="text/html; charset=windows-1251">
	<TITLE></TITLE>
	<META NAME="GENERATOR" CONTENT="OpenOffice 4.1.1  (Win32)">
	<META NAME="CREATED" CONTENT="20171009;15204727">
	<META NAME="CHANGED" CONTENT="20171009;16580339">
</HEAD>
<BODY LANG="en-US" DIR="LTR">
<DL>
	<DT>TightVNC server and client were updated so that they can
	exchange of additional information before launching RFB session.
	This exchange is performed by the same TCP channel which is used for
	RFB.<DT>
	<BR>
	<DT>When Server&amp;Client are running in Cistera mode, some new
	steps are added into their interaction comparing with TightVNC mode.
	These new steps marked with '*'. 
	<DT><BR>
</DL>
<UL>
	<LI>Client connects to Server RFB port;<LI>
	Server accepts connection;<LI>
	*Client sends <SPAN LANG="ru-RU">CisteraHandshake:: clientRequest
	</SPAN>(see CisteraHandshake.h) with settings that are specified on
	Client by the user;<LI>
	*Server sends <SPAN LANG="ru-RU">CisteraHandshake::</SPAN>serverResponse<SPAN LANG="ru-RU">
	</SPAN>(see CisteraHandshake.h) with parameters needed by Client;<LI>
	*if mpeg stream was requested, Client starts process:<P>
	if encryption was requested:<P>
	<SPAN LANG="en-US">&gt;</SPAN><FONT COLOR="#a31515"><FONT FACE="Consolas"><FONT SIZE=2>ffplay.exe
	-srtp_in_suite AES_CM_128_HMAC_SHA1_80 -srtp_in_params
	&lt;</FONT></FONT></FONT><FONT COLOR="#000000"><FONT FACE="Consolas"><FONT SIZE=2>mpegStreamAesKeySalt
	received from Server and </FONT></FONT></FONT><FONT COLOR="#000000"><FONT FACE="Consolas"><FONT SIZE=2><SPAN LANG="en-US">converted
	into base64 encoded string</SPAN></FONT></FONT></FONT><FONT COLOR="#a31515"><FONT FACE="Consolas"><FONT SIZE=2>&gt;
	srtp://127.0.0.1:&lt;</FONT></FONT></FONT><FONT COLOR="#000000"><FONT FACE="Consolas"><FONT SIZE=2>mpegStreamPort</FONT></FONT></FONT><FONT COLOR="#a31515"><FONT FACE="Consolas"><FONT SIZE=2>&gt;</FONT></FONT></FONT><P>
	<FONT COLOR="#000000"><FONT FACE="Times New Roman"><FONT SIZE=3>else:</FONT></FONT></FONT><P>
	<FONT COLOR="#000000"><FONT FACE="Times New Roman"><FONT SIZE=3><SPAN LANG="en-US">&gt;</SPAN></FONT></FONT></FONT><FONT COLOR="#a31515"><FONT FACE="Consolas"><FONT SIZE=2>ffplay.exe
	udp://127.0.0.1:&lt;</FONT></FONT></FONT><FONT COLOR="#000000"><FONT FACE="Consolas"><FONT SIZE=2>mpegStreamPort</FONT></FONT></FONT><FONT COLOR="#a31515"><FONT FACE="Consolas"><FONT SIZE=2>&gt;</FONT></FONT></FONT><LI>
	*if encryption was requested, both Server&amp;Client start SSL on
	the current TCP connection. OpenSSL1.1 is used. Client acts as SSL
	client (see SocketIPv4.cpp) and Server as SSL server;<LI>
	*if mpeg stream was requested, Server starts ffmpeg with the
	parameters set by Client;<LI>
	From this point everything is acting like with TightVNC that's
	Server starts RFB handshake etc; 
	<LI>*during connection, if RFB video was not requested, Server does
	not send updates to Client (so that Client's VNC window is blank);</UL>
<DL>
	<DT><BR>
	<DT><BR>
	<DT><FONT FACE="Times New Roman"><FONT SIZE=3><SPAN LANG="en-US">Generally,
	to make a VNC client (which is </SPAN><FONT COLOR="#222222"><SPAN LANG="en-US">vncrec</SPAN></FONT><SPAN LANG="en-US">
	in your case) support CisteraVNC server, you only need to insert
	function </SPAN><FONT COLOR="#000000"><SPAN LANG="en-US">cisteraHandshake
	(see RemoteViewverCode.cpp) after opening TCP connection to Server
	and before RFB handshake.</SPAN></FONT></FONT></FONT><DT>
	<BR>
	<DT><BR>
	<DT><FONT FACE="Times New Roman"><FONT SIZE=3>class CisteraHandshake</FONT></FONT><DT>
	{<DT>
	public:<DT>
	<BR>
	<DT>	struct clientRequest<DT>
		{<DT>
			char clientVersion[4] = &quot;1.0&quot;;<DT>
			bool encrypt = true;<DT>
			bool mpegStream = true;<DT>
			byte mpegFramerate = 10;<DT>
			bool rfbVideo = false;<DT>
			UINT16 mpegStreamPort = 5720;<DT>
		};<DT>
	<BR>
	<DT>	static const int AesKeySalt_SIZE = 30;<DT>
	<BR>
	<DT>	struct serverResponse<DT>
		{<DT>
			char serverVersion[4] = &quot;1.0&quot;;<DT>
			byte mpegStreamAesKeySalt[AesKeySalt_SIZE];<DT>
		};<DT>
	};<DT>
	<BR>
	<DT><BR>
	<DT>Client converts plain socket into SSL socket:<DT>
	<BR>
	<DT><FONT COLOR="#000000"><FONT FACE="Consolas"><FONT SIZE=2>		</FONT></FONT></FONT><FONT COLOR="#6f008a"><FONT FACE="Consolas"><FONT SIZE=2>ERR_load_crypto_strings</FONT></FONT></FONT><FONT COLOR="#000000"><FONT FACE="Consolas"><FONT SIZE=2>();</FONT></FONT></FONT><DT>
	<FONT COLOR="#000000"><FONT FACE="Consolas"><FONT SIZE=2>		</FONT></FONT></FONT><FONT COLOR="#6f008a"><FONT FACE="Consolas"><FONT SIZE=2>SSL_load_error_strings</FONT></FONT></FONT><FONT COLOR="#000000"><FONT FACE="Consolas"><FONT SIZE=2>();</FONT></FONT></FONT><DT>
	<FONT COLOR="#000000"><FONT FACE="Consolas"><FONT SIZE=2>		</FONT></FONT></FONT><FONT COLOR="#6f008a"><FONT FACE="Consolas"><FONT SIZE=2>OpenSSL_add_ssl_algorithms</FONT></FONT></FONT><FONT COLOR="#000000"><FONT FACE="Consolas"><FONT SIZE=2>();</FONT></FONT></FONT><DT>
	<BR>
	<DT><FONT COLOR="#000000"><FONT FACE="Consolas"><FONT SIZE=2>	</FONT></FONT></FONT><FONT COLOR="#0000ff"><FONT FACE="Consolas"><FONT SIZE=2>const</FONT></FONT></FONT><FONT COLOR="#000000"><FONT FACE="Consolas"><FONT SIZE=2>
	</FONT></FONT></FONT><FONT COLOR="#2b91af"><FONT FACE="Consolas"><FONT SIZE=2>SSL_METHOD</FONT></FONT></FONT><FONT COLOR="#000000"><FONT FACE="Consolas"><FONT SIZE=2>*
	method = </FONT></FONT></FONT><FONT COLOR="#6f008a"><FONT FACE="Consolas"><FONT SIZE=2>SSLv23_client_method</FONT></FONT></FONT><FONT COLOR="#000000"><FONT FACE="Consolas"><FONT SIZE=2>();</FONT></FONT></FONT><DT>
	<FONT COLOR="#000000"><FONT FACE="Consolas"><FONT SIZE=2>	</FONT></FONT></FONT><FONT COLOR="#2b91af"><FONT FACE="Consolas"><FONT SIZE=2>SSL_CTX</FONT></FONT></FONT><FONT COLOR="#000000"><FONT FACE="Consolas"><FONT SIZE=2>*
	m_sslCtx = SSL_CTX_new(method);</FONT></FONT></FONT><DT>
	<BR>
	<DT><FONT COLOR="#000000"><FONT FACE="Consolas"><FONT SIZE=2>	m_ssl_socket
	= SSL_new(m_sslCtx);</FONT></FONT></FONT><DT>
	<FONT COLOR="#000000"><FONT FACE="Consolas"><FONT SIZE=2>	</FONT></FONT></FONT><FONT COLOR="#0000ff"><FONT FACE="Consolas"><FONT SIZE=2>if</FONT></FONT></FONT><FONT COLOR="#000000"><FONT FACE="Consolas"><FONT SIZE=2>(m_ssl_socket
	== </FONT></FONT></FONT><FONT COLOR="#6f008a"><FONT FACE="Consolas"><FONT SIZE=2>NULL</FONT></FONT></FONT><FONT COLOR="#000000"><FONT FACE="Consolas"><FONT SIZE=2>)</FONT></FONT></FONT><DT>
	<FONT COLOR="#000000"><FONT FACE="Consolas"><FONT SIZE=2>		throwSslException();</FONT></FONT></FONT><DT>
	<FONT COLOR="#000000"><FONT FACE="Consolas"><FONT SIZE=2>	SSL_set_fd(m_ssl_socket,
	m_socket);</FONT></FONT></FONT><DT>
	<FONT COLOR="#000000"><FONT FACE="Consolas"><FONT SIZE=2>		</FONT></FONT></FONT><FONT COLOR="#0000ff"><FONT FACE="Consolas"><FONT SIZE=2>if</FONT></FONT></FONT><FONT COLOR="#000000"><FONT FACE="Consolas"><FONT SIZE=2>
	(SSL_connect(m_ssl_socket) &lt;= 0)</FONT></FONT></FONT><DT>
	<FONT COLOR="#000000"><FONT FACE="Consolas"><FONT SIZE=2>			throwSslException();</FONT></FONT></FONT><DT>
	<BR>
	<DT><SPAN LANG="en-US">now </SPAN><FONT COLOR="#000000"><FONT FACE="Consolas"><FONT SIZE=2>m_ssl_socket</FONT></FONT></FONT><SPAN LANG="en-US">
	can be used for reading/writing:</SPAN><DT>
	<BR>
	<DT><FONT COLOR="#000000"><FONT FACE="Consolas"><FONT SIZE=2><SPAN LANG="en-US">SSL_read(m_</SPAN></FONT></FONT></FONT><FONT COLOR="#000000"><FONT FACE="Consolas"><FONT SIZE=2>ssl_socket</FONT></FONT></FONT><FONT COLOR="#000000"><FONT FACE="Consolas"><FONT SIZE=2><SPAN LANG="en-US">,
	</SPAN></FONT></FONT></FONT><FONT COLOR="#808080"><FONT FACE="Consolas"><FONT SIZE=2><SPAN LANG="en-US">buffer</SPAN></FONT></FONT></FONT><FONT COLOR="#000000"><FONT FACE="Consolas"><FONT SIZE=2><SPAN LANG="en-US">,
	</SPAN></FONT></FONT></FONT><FONT COLOR="#808080"><FONT FACE="Consolas"><FONT SIZE=2><SPAN LANG="en-US">size</SPAN></FONT></FONT></FONT><FONT COLOR="#000000"><FONT FACE="Consolas"><FONT SIZE=2><SPAN LANG="en-US">);	</SPAN></FONT></FONT></FONT><DT>
	<FONT COLOR="#000000"><FONT FACE="Consolas"><FONT SIZE=2><SPAN LANG="en-US">SSL_write(m</SPAN></FONT></FONT></FONT><FONT COLOR="#000000"><FONT FACE="Consolas"><FONT SIZE=2>_ssl_socket</FONT></FONT></FONT><FONT COLOR="#000000"><FONT FACE="Consolas"><FONT SIZE=2><SPAN LANG="en-US">,
	</SPAN></FONT></FONT></FONT><FONT COLOR="#808080"><FONT FACE="Consolas"><FONT SIZE=2><SPAN LANG="en-US">data</SPAN></FONT></FONT></FONT><FONT COLOR="#000000"><FONT FACE="Consolas"><FONT SIZE=2><SPAN LANG="en-US">,
	</SPAN></FONT></FONT></FONT><FONT COLOR="#808080"><FONT FACE="Consolas"><FONT SIZE=2><SPAN LANG="en-US">size</SPAN></FONT></FONT></FONT><FONT COLOR="#000000"><FONT FACE="Consolas"><FONT SIZE=2><SPAN LANG="en-US">);</SPAN></FONT></FONT></FONT><DT>
	<BR>
	<DT>When closing, it should be properly destroyed but it is not
	necessary if the process quits as well.</DL>
</BODY>
</HTML>